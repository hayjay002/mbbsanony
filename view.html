<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>View Messages - MBBSAnonymous</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600&family=Roboto&display=swap" rel="stylesheet">

<style>
body {
  margin: 0;
  font-family: 'Roboto', sans-serif;
  background: #0F111A;
  color: #ECECEC;
  padding: 20px;
}

h1 {
  font-family: 'Poppins', sans-serif;
  text-align: center;
  color: #4FA3F7;
}

/* Search */
#search {
  width: 100%;
  max-width: 500px;
  padding: 12px 15px;
  margin: 20px auto;
  display: block;
  border-radius: 15px;
  border: 1px solid rgba(255,255,255,0.2);
  background: rgba(255,255,255,0.05);
  color: #ECECEC;
}

/* Toolbar */
.toolbar {
  display: flex;
  justify-content: center;
  gap: 15px;
  margin-bottom: 20px;
}

.toolbar button {
  padding: 10px 18px;
  border: none;
  border-radius: 14px;
  font-weight: bold;
  cursor: pointer;
  background: linear-gradient(45deg,#4FA3F7,#28B463);
  color: #fff;
}

/* Grid */
.messages {
  display: grid;
  grid-template-columns: repeat(auto-fill,minmax(220px,1fr));
  gap: 20px;
}

/* Glassy Square Card */
.card {
  position: relative;
  aspect-ratio: 1 / 1;
  background: rgba(255,255,255,0.08);
  backdrop-filter: blur(14px);
  border: 1px solid rgba(255,255,255,0.25);
  border-radius: 18px;
  padding: 18px;

  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;

  cursor: pointer;
}

/* Checkbox */
.card input[type="checkbox"] {
  position: absolute;
  top: 12px;
  left: 12px;
  transform: scale(1.3);
}

/* Message text */
.card p {
  text-align: center;
  font-size: 15px;
  line-height: 1.4;
  word-break: break-word;
}

/* Timestamp */
.timestamp {
  position: absolute;
  bottom: 10px;
  right: 12px;
  font-size: 11px;
  color: #B0B0B0;
}
</style>
</head>

<body>
<h1>Anonymous Messages</h1>

<input id="search" placeholder="Search messages...">

<div class="toolbar">
  <button id="deleteSelected">Delete Selected</button>
  <button id="downloadSelected">Download Selected</button>
</div>

<div class="messages" id="messagesContainer"></div>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getFirestore, collection, getDocs, deleteDoc, doc, orderBy, query } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyC0OXKYEwh7aNeAZ2JkY8Q-WdOCr_MTApg",
  authDomain: "anonymous0000-bbbe.firebaseapp.com",
  projectId: "anonymous0000-bbbe",
  storageBucket: "anonymous0000-bbbe.appspot.com",
  messagingSenderId: "569708942202",
  appId: "1:569708942202:web:00e0f96d314da5f5c37cc3"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const container = document.getElementById("messagesContainer");
const search = document.getElementById("search");

let allMessages = [];

/* LOAD */
async function loadMessages() {
  container.innerHTML = "";
  const q = query(collection(db,"messages"), orderBy("timestamp","desc"));
  const snap = await getDocs(q);

  allMessages = snap.docs.map(d => ({ id:d.id, ...d.data() }));
  render(allMessages);
}

function render(list) {
  container.innerHTML = "";
  list.forEach(m => {
    const card = document.createElement("div");
    card.className = "card";
    card.dataset.id = m.id;

    card.innerHTML = `
      <input type="checkbox">
      <p>${m.text}</p>
      <div class="timestamp">${m.timestamp?.toDate?.().toLocaleString() || ""}</div>
    `;
    container.appendChild(card);
  });
}

/* SEARCH */
search.addEventListener("input", () => {
  const t = search.value.toLowerCase();
  render(allMessages.filter(m => m.text.toLowerCase().includes(t)));
});

/* DELETE */
document.getElementById("deleteSelected").onclick = async () => {
  const selected = [...document.querySelectorAll(".card input:checked")]
    .map(cb => cb.parentElement.dataset.id);

  if (!selected.length) return alert("Select messages first");

  if (!confirm("Delete selected messages?")) return;

  try {
    await Promise.all(
      selected.map(id => deleteDoc(doc(db, "messages", id)))
    );
    alert("Deleted successfully âœ…");
    loadMessages();
  } catch (err) {
    console.error("Delete failed:", err);
    alert("Delete failed. Check console.");
  }
};


/* DOWNLOAD (iOS SAFE) */
document.getElementById("downloadSelected").onclick = async () => {
  const cards = [...document.querySelectorAll(".card input:checked")]
    .map(cb => cb.parentElement);

  if (!cards.length) return alert("Select messages first");

  for (let i=0;i<cards.length;i++) {
    const card = cards[i];
    const checkbox = card.querySelector("input");
    checkbox.style.display = "none";

    const canvas = await html2canvas(card,{backgroundColor:null});
    checkbox.style.display = "block";

    const blob = await (await fetch(canvas.toDataURL())).blob();
    const file = new File([blob],`message-${i+1}.png`,{type:"image/png"});

    if (navigator.share) {
      await navigator.share({ files:[file] });
    } else {
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = file.name;
      a.click();
    }
  }
};

loadMessages();
</script>

</body>
</html>

